# [[ Options ]]

# Use true terminal colors
set-option -sa terminal-overrides ",xterm*:Tc"

# Make possible to use less common keymaps like <C-CR> or <C-S-a>
set -g extended-keys on
set -sa terminal-features ",*:extkeys"

# Enable mouse mode
set-option -g mouse on

# Start windows and panes indexing at 1 instead of 0
set-option -g base-index 1
set-option -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on

# Change the tmux keymap prefix
unbind-key C-b # Default prefiex
set-option -g prefix C-Space
bind-key C-Space send-prefix

# Enable vim-like keymaps
set-window-option -g mode-keys vi

# Increase the maximal length of the left status bar section
set -g status-left-length 30

# Don't inherit `VIRTUAL_ENV` variable from parent shell (doesn't come with the actual virtualenv activation and causes issues with the Python virtualenv activation hooks)
set-environment -gr VIRTUAL_ENV

# [[ Keymaps ]]
# Default keymaps can be seen with the `<prefix>?` keymap

# Override session and window switching keymaps with fzf
bind-key s display-popup -E "\
    tmux list-sessions -F '#{session_last_attached} #{session_name} (#{session_windows} windows)' |\
    sort -rn |\
    fzf --layout=reverse --prompt ' Sessions > ' --with-nth=2.. --bind 'load:pos(2)' --bind 'enter:execute-silent(tmux switch-client -t {2})+abort'"
bind-key w display-popup -E "\
    tmux list-windows -a -F '#{window_activity} #{session_name}:#{window_index} - #{window_name} (#{window_panes} panes)' |\
    sort -rn |\
    fzf --layout=reverse --prompt ' Windows > ' --with-nth=2.. --bind 'load:pos(2)' --bind 'enter:execute-silent(tmux switch-client -t {2})+abort'"

# Make sure split keymaps open the new pane in the current directory
bind-key '"' split-window -v -c "#{pane_current_path}"
bind-key '%' split-window -h -c "#{pane_current_path}"

# Define new keymaps
bind-key a new-window -a # Create window after current one
bind-key b new-window -b # Create window before current one
bind-key e swap-window -t '{last}' \; last-window # Exchange current and last windows
bind-key J join-pane -h -s ! # Join current and last windows
bind-key r source-file ~/.config/tmux/tmux.conf \; display-message "tmux.conf reloaded"

# Define repeatable window navigation keymaps
bind-key -r C-n next-window
bind-key -r C-p previous-window

# Use control with number keys (without prefix) to select windows
bind-key -n C-1 select-window -t 1
bind-key -n C-2 select-window -t 2
bind-key -n C-3 select-window -t 3
bind-key -n C-4 select-window -t 4
bind-key -n C-5 select-window -t 5
bind-key -n C-6 select-window -t 6
bind-key -n C-7 select-window -t 7
bind-key -n C-8 select-window -t 8
bind-key -n C-9 select-window -t 9
bind-key -n C-0 select-window -t 10

# Define Vim-like keymaps for pane resizing
bind-key -r C-h resize-pane -L 3
bind-key -r C-j resize-pane -D 3
bind-key -r C-k resize-pane -U 3
bind-key -r C-l resize-pane -R 3

# Enable Vim-like keymaps in copy mode
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# [[ Plugins ]]

# Change plugins install location
set-environment -g TMUX_PLUGIN_MANAGER_PATH '~/.tmux/plugins'

# Setup TPM, the Tmux Plugin Manager
set -g @plugin 'tmux-plugins/tpm'

# Define the TPM plugins
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @vim_navigator_prefix_mapping_clear_screen "" # Make possible to use <C-l> in keymaps
set -g @plugin 'schasse/tmux-jump'

# Setup the theme with default values and the current theme file, if it exists
# Note that sourcing a theme file with a plugin doesn't work in an if-shell or inside a shell script (known issue with TPM)
set -g status-right "#h"
set -g status-style bg=default
source-file -q ~/.config/tmux/theme/tmux-current.conf

# Run the TPM plugins setup (this should be kept at the bottom of the file)
run '~/.tmux/plugins/tpm/tpm'
